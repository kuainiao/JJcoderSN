# ä¼ä¸šé˜²ç«å¢™ä¹‹ iptables

## 1.1 ä¼ä¸šä¸­å®‰å…¨ä¼˜åŒ–é…ç½®åŸåˆ™

å°½å¯èƒ½ä¸ç»™æœåŠ¡å™¨é…ç½®å¤–ç½‘ip ,å¯ä»¥é€šè¿‡ä»£ç†è½¬å‘æˆ–è€…é€šè¿‡é˜²ç«å¢™æ˜ å°„.å¹¶å‘ä¸æ˜¯ç‰¹åˆ«å¤§æƒ…å†µæœ‰å¤–ç½‘ip,å¯ä»¥å¼€å¯é˜²ç«å¢™æœåŠ¡.

å¤§å¹¶å‘çš„æƒ…å†µï¼Œä¸èƒ½å¼€iptables,å½±å“æ€§èƒ½ï¼Œåˆ©ç”¨ç¡¬ä»¶é˜²ç«å¢™æå‡æ¶æ„å®‰å…¨

### 1.1.1 ç”Ÿäº§ä¸­ iptables çš„å®é™…åº”ç”¨

ä¸»è¦åº”ç”¨æ–¹å‘

1ã€ä¸»æœºé˜²ç«å¢™ï¼ˆfilterè¡¨çš„INPUTé“¾ï¼‰ã€‚

2ã€å±€åŸŸç½‘å…±äº«ä¸Šç½‘(nat è¡¨çš„ POSTROUTING é“¾)ã€‚åŠä¸ªè·¯ç”±å™¨ï¼ŒNATåŠŸèƒ½ã€‚

3ã€ç«¯å£åŠIPæ˜ å°„(nat è¡¨çš„ PREROUTING é“¾)ï¼Œç¡¬é˜²çš„NATåŠŸèƒ½ã€‚

4ã€IPä¸€å¯¹ä¸€æ˜ å°„ã€‚

**å…¶ä»–è¯´æ˜ï¼š**

>  â‘ iptablesæ˜¯åŸºäºå†…æ ¸çš„é˜²ç«å¢™ï¼ŒåŠŸèƒ½éå¸¸å¼ºå¤§ï¼ŒåŸºäºæ•°æ®åŒ…çš„è¿‡æ»¤ï¼ç‰¹åˆ«æ˜¯å¯ä»¥åœ¨ä¸€å°éå¸¸ä½çš„ç¡¬ä»¶é…ç½®ä¸‹è·‘çš„éå¸¸å¥½ã€‚
>
> ã€€ã€€**æ³¨ï¼š**iptablesä¸»è¦å·¥ä½œåœ¨OSIä¸ƒå±‚çš„2.3.4å±‚ã€‚ä¸ƒå±‚çš„æ§åˆ¶å¯ä»¥ä½¿ç”¨squidä»£ç†+iptablesã€‚
>
> â‘¡iptabesï¼šç”Ÿäº§ä¸­æ ¹æ®å…·ä½“æƒ…å†µï¼Œä¸€èˆ¬ï¼Œå†…ç½‘å…³é—­ï¼Œå¤–ç½‘æ‰“å¼€ã€‚å¤§å¹¶å‘çš„æƒ…å†µä¸èƒ½å¼€iptablesï¼Œå½±å“æ€§èƒ½ï¼Œiptablesæ˜¯è¦æ¶ˆè€—CPUçš„ï¼Œæ‰€ä»¥å¤§å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¡¬ä»¶é˜²ç«å¢™çš„å„æ–¹é¢åšçš„å¾ˆä»”ç»†ã€‚selinuxï¼šç”Ÿäº§ä¸­ä¹Ÿæ˜¯å…³é—­çš„ã€‚å¯ä»¥åšidsçš„å…¥ä¾µæ£€æµ‹ã€‚
>
> â‘¢å®é™…ç”Ÿäº§ä¸­å°½å¯èƒ½ä¸ç»™æœåŠ¡å™¨é…ç½®å¤–ç½‘IPã€‚å¯ä»¥é€šè¿‡ä»£ç†è½¬å‘ã€‚æ¯”å¦‚ï¼Œnagioså°±ä¸éœ€è¦å¤–ç½‘ã€‚
>
> â‘£å¹¶å‘ä¸æ˜¯å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå†å¤–ç½‘çš„IPç¯å¢ƒï¼Œå¼€é˜²ç«å¢™ã€‚
>
> â‘¤ç¬¬ä¸€æ¬¡ç›´æ¥é»˜è®¤è§„åˆ™ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œä»¥åå°±åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œä¿®æ”¹ï¼ˆç¼–è¾‘æ·»åŠ åˆ é™¤ï¼‰ã€‚
>
> â‘¥å°æ‰IPï¼šæ ¹æ®IPåœ°å€å’Œç½‘ç»œè¿æ¥æ•°è¿›è¡Œå°æ€ã€‚ï¼ˆå®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶å°æ‰ï¼Œåˆ¤æ–­ï¼Œå­˜åœ¨å°±ä¸å†è¿›è¡ŒäºŒæ¬¡å°æ€ï¼‰

### 1.1.2 ä¼ä¸šå¸¸ç”¨æ¡ˆä¾‹åŠŸèƒ½å°ç»“ï¼š

1ï¼‰linuxä¸»æœºé˜²ç«å¢™ï¼Œå•æœºä½œä¸ºé˜²ç«å¢™ï¼ˆè¡¨filterï¼‰ã€‚

2ï¼‰å±€åŸŸç½‘å…±äº«ä¸Šç½‘ï¼ˆè¡¨nat postroutingï¼‰ã€‚

3ï¼‰å¤–éƒ¨åœ°å€æ˜ å°„ä¸ºå†…éƒ¨åœ°å€å’Œç«¯å£ï¼ˆè¡¨nat preroutingï¼‰

## 1.2 iptables é˜²ç«å¢™ç®€ä»‹

Netfilter/Iptables(ä»¥ä¸‹ç®€ç§°Iptables)æ˜¯unix/linuxè‡ªå¸¦çš„ä¸€æ¬¾ä¼˜ç§€ä¸”å¼€æ”¾æºä»£ç çš„å®Œå…¨è‡ªç”±çš„åŸºäºåŒ…è¿‡æ»¤çš„é˜²ç«å¢™å·¥å…·ï¼Œå®ƒçš„åŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œä½¿ç”¨éå¸¸çµæ´»ï¼Œå¯ä»¥å¯¹æµå…¥å’Œæµå‡ºæœåŠ¡å™¨çš„æ•°æ®åŒ…è¿›è¡Œå¾ˆç²¾ç»†çš„æ§åˆ¶.ç‰¹åˆ«æ˜¯å®ƒå¯ä»¥åœ¨ä¸€å°éå¸¸ä½çš„ç¡¬ä»¶é…ç½®æœåŠ¡å™¨ä¸Šè·‘çš„éå¸¸å¥½ï¼ˆèµ›æ‰¬500HZ cpu 64M å†…å­˜çš„æƒ²å†µä¸‹éƒ¨ç½²ç½‘å…³é˜²ç«å¢™ï¼‰ï¼Œæä¾›è¿‘400äººçš„ä¸Šç½‘æœåŠ¡ä¸æ¯«ä¸é€Šè‰²ä¼ä¸šçº§ä¸“ä¸šè·¯ç”±å™¨é˜²ç«å¢™ã€‚ iptables + zebra + squid (ä¼ä¸šå¸¸ç”¨ç½‘ç»œå¼€æºäº§å“ï¼‰ã€‚

   iptablesæ˜¯linux2.4åŠ2.6å†…æ ¸ä¸­é›†æˆçš„æœåŠ¡ï¼Œå…¶åŠŸèƒ½ä¸å®‰å…¨æ€§æ¯”å…¶è€ä¸€èœšipfwadmï¼Œipchains å¼ºå¤§çš„å¤šï¼Œiptablesä¸»è¦å·¥ä½œåœ¨0SIä¸ƒå±‚çš„äºŒã€ä¸‰ã€å››å±‚ï¼Œå¦‚æœé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œiptablesä¹Ÿå¯ä»¥æ”¯æŒ 7 å±‚æ§åˆ¶ï¼ˆsquidä»£ç†+iptablesï¼‰ã€‚

### 1.2.1 iptablesåè¯å’Œæœ¯è¯­

ä¸å°‘åˆšæ¥è§¦åˆ°iptablesçš„æœ‹å‹å¯èƒ½ä¼šå¯¹iptablesé˜²ç«å¢™çš„ç›¸å…³åè¯æçš„å¾ˆæ™•ï¼Œä¸çŸ¥é“å…¶æ‰€äº‘çš„å…·ä½“æ„æ€ï¼Œè€Œæ˜¯å°±æœ€åŸºæœ¬çš„èƒ½è®©å¤§å®¶å®¹æ˜“å¿«é€Ÿç†è§£å’ŒæŒæ¡çš„æ€è·¯æ¥æè¿°ï¼š

å®¹å™¨ï¼šåŒ…å«æˆ–è€…è¯´å±äºçš„å…³ç³»

### 1.2.2 ä»€ä¹ˆæ˜¯å®¹å™¨

è°ä¸çŸ¥é“å•Šï¼Œå®¹å™¨å°±æ˜¯è£…ä¸œè¥¿çš„ï¼Œå¦‚ï¼ˆç®±ã€åŒ…ã€å›ï¼‰ã€‚æ²¡é”™ï¼Œæ­å–œä½ ç­”å¯¹äº†.è¯å…¸é‡Œè§£é‡Šè¯´ï¼Œå®¹å™¨å°±æ˜¯ç”¨æ¥åŒ…è£…æˆ–è£…è½½ç‰©å“çš„è´®å­˜å™¨ï¼ˆå¦‚ç®±ã€ç½ã€å›ï¼‰æˆ–è€…æˆå½¢æˆ–æŸ”è½¯ä¸æˆå½¢çš„åŒ…è¦†ææ–™.

åœ¨iptablesé‡Œçš„å‘¢ï¼Œå°±æ˜¯ç”¨æ¥æè¿°è¿™ç§åŒ…å«æˆ–è€…è¯´å±äºçš„å…³ç³»ã€‚

### 1.2.3 ä»€ä¹ˆæ˜¯ Netfilter/iptables ?

Netfilteræ˜¯è¡¨ï¼ˆtablesï¼‰çš„å®¹å™¨ï¼Œè¿™æ ·è§£é‡Šå¤§å®¶è‚¯å®šè¿˜æ˜¯æ™•ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæŠŠNetfilterçœ‹æˆæ˜¯æŸä¸ªå°åŒºçš„ä¸€æ ‹æ¥¼ã€‚é‚£ä¹ˆè¡¨ï¼ˆtables)å°±æ˜¯æ¥¼é‡Œçš„å…¶ä¸­çš„ä¸€å¥—æˆ¿å­ã€‚è¿™å¥—æˆ¿å­"è¡¨ï¼ˆtables)"å±äºè¿™æ ‹â€œNetfilterâ€ã€‚

### 1.2.4 ä»€ä¹ˆæ˜¯è¡¨ï¼ˆtablesï¼‰ï¼Ÿ

è¡¨ï¼ˆtablesï¼‰æ˜¯é“¾çš„å®¹å™¨ï¼Œå³æ‰€æœ‰çš„é“¾ï¼ˆchainsï¼‰éƒ½å±äºå…¶å¯¹åº”çš„è¡¨ï¼ˆtablesï¼‰.å¦‚ä¸Šï¼Œå¦‚æœæŠŠNetfilterçœ‹æˆæ˜¯æŸä¸ªå°åŒºçš„ä¸€æ ‹æ¥¼.é‚£ä¹ˆè¡¨ï¼ˆtablesï¼‰å°±æ˜¯æ¥¼é‡Œçš„å…¶ä¸­çš„ä¸€å¥—æˆ¿å­ã€‚

### 1.2.5 ä»€ä¹ˆæ˜¯é“¾ï¼ˆchainsï¼‰ï¼Ÿ

é“¾ï¼ˆchainsï¼‰æ˜¯è§„åˆ™ï¼ˆPolicysï¼‰çš„å®¹å™¨ã€‚æ¥ä¸Šï¼Œå¦‚æœæŠŠè¡¨ï¼ˆtablesï¼‰å½“ä½œæœ‰ä¸€å¥—æˆ¿å­ï¼Œé‚£ä¹ˆé“¾ï¼ˆchainsï¼‰å°±å¯ä»¥è¯´æ˜¯æˆ¿å­é‡Œçš„å®¶å…·ï¼ˆæŸœå­ç­‰ï¼‰ã€‚

### 1.2.6 ä»€ä¹ˆæ˜¯è§„åˆ™ï¼ˆPolicyï¼‰ï¼Ÿ

è§„åˆ™ï¼ˆPolicyï¼‰å°±æ¯”è¾ƒå®¹æ˜“ç†è§£äº†ï¼Œå°±æ˜¯iptablesç³»åˆ—è¿‡æ»¤ä¿¡æ¯çš„è§„èŒƒå’Œå…·ä½“æ–¹æ³•æ¡æ¬¾äº†.å¯ä»¥ç†è§£ä¸ºæŸœå­å¦‚ä½•å¢åŠ å¹¶æ‘†æ”¾æŸœå­ä¸œè¥¿ç­‰ã€‚

åŸºæœ¬æœ¯è¯­å¦‚ä¸‹è¡¨æ ¼æ‰€ç¤ºï¼š

| **Netfilter** | **è¡¨ï¼ˆtables****ï¼‰** | **é“¾ï¼ˆchains****ï¼‰** | **è§„åˆ™ï¼ˆPolicy****ï¼‰** |
| ------------- | -------------------- | -------------------- | ---------------------- |
| **ä¸€æ ‹æ¥¼**    | æŒ‰é‡Œçš„æˆ¿å­           | æˆ¿å­é‡Œçš„æŸœå­         | æŸœå­é‡Œè¡£æœï¼Œæ‘†æ”¾è§„åˆ™   |

## 1.3 iptables è¡¨å’Œé“¾

æè¿°å®Œiptablesæœ¯è¯­åï¼Œç›¸ä¿¡å¤§å®¶å¯¹iptablesçš„è¡¨å’Œé“¾æœ‰äº†åˆæ­¥çš„äº†è§£äº†ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œiptablesæ ¹æ®åŠŸèƒ½å’Œè¡¨çš„å®šä¹‰åˆ’åˆ†åŒ…å«ä¸‰ä¸ªè¡¨ï¼Œfilter,nat,mangle,å…¶æ¯ä¸ªè¡¨åˆåŒ…å«ä¸åŒçš„æ“ä½œé“¾ï¼ˆchains )ã€‚ å®é™…iptablesåŒ…å«4å¼ è¡¨å’Œäº”ä¸ªé“¾,å·§ä¸»è¦è®°ä½ä¸¤å¼ è¡¨å³å¯filterå’Œnatè¡¨å³å¯ã€‚

ä¸‹é¢è¡¨æ ¼å±•ç¤ºäº†è¡¨å’Œé“¾çš„å¯¹åº”å…³ç³»ã€‚

**å››ä¸ªè¡¨ï¼š**

| **è¡¨ï¼ˆtables****ï¼‰** | **é“¾ï¼ˆchains****ï¼‰**                                         |
| -------------------- | ------------------------------------------------------------ |
| **Filter**           | è¿™æ˜¯é»˜è®¤è¡¨ï¼Œå®ç°é˜²ç«å¢™æ•°æ®è¿‡æ»¤åŠŸèƒ½ã€‚                         |
| **INPUT**            | å¯¹äºæŒ‡å®šåˆ°æœ¬åœ°å¥—æ¥å­—çš„åŒ…ï¼Œå³åˆ°è¾¾æœ¬åœ°é˜²ç«å¢™æœåŠ¡å™¨çš„æ•°æ®åŒ…ã€‚   |
| **FORWARD**          | è·¯ç”±ç©¿è¿‡çš„æ•°æ®åŒ…ï¼Œå³ç»è¿‡æœ¬åœ°é˜²ç«å¢™æœåŠ¡å™¨çš„æ•°æ®åŒ…ã€‚           |
| **OUTPUT**           | æœ¬åœ°åˆ›å»ºçš„æ•°æ®åŒ…                                             |
| **NAT**              | å½“é‡åˆ°æ–°åˆ›å»ºçš„æ•°æ®åŒ…è¿æ¥æ—¶å°†å‚è€ƒè¿™ä¸ªè¡¨                       |
| **FREROUTING**       | ä¸€è¿›æ¥å°±å¯¹æ•°æ®åŒ…è¿›è¡Œæ”¹å˜                                     |
| **OUTPUT**           | æœ¬åœ°åˆ›å»ºçš„æ•°æ®åŒ…åœ¨è·¯ç”±å‰è¿›è¡Œæ”¹å˜                             |
| **POSTROUTING**      | åœ¨æ•°æ®åŒ…å³å°†å‡ºå»æ—¶æ”¹å˜æ•°æ®åŒ…ä¿¡æ¯                             |
| **Mangle**           | è¿™ä¸ªè¡¨ä¸“é—¨ç”¨äºæ”¹å˜æ•°æ®åŒ…                                     |
| **INPUT**            | è¿›å…¥åˆ°è®¾å¤‡æœ¬èº«çš„åŒ…                                           |
| **FORWARD**          | å¯¹è·¯ç”±åçš„æ•°æ®åŒ…ä¿¡æ¯è¿›è¡Œä¿®æ”¹                                 |
| **FREROUTING**       | åœ¨è·¯ç”±ä¹‹å‰æ›´æ”¹ä¼ å…¥çš„åŒ…                                       |
| **OUTPUT**           | æœ¬åœ°åˆ›å»ºçš„æ•°æ®åŒ…åœ¨è·¯ç”±ä¹‹å‰æ”¹å˜                               |
| **POSTROUTING**      | åœ¨æ•°æ®åŒ…å³å°†ç¦»å¼€æ—¶æ›´æ”¹æ•°æ®åŒ…ä¿¡æ¯                             |
| **raw**              | **æ­¤è¡¨ç”¨å¤„è¾ƒå°‘ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚**This  table is used mainly for configuring exemptions from connection tracking in combination with the  NOTRACK  target. |
| **PREROUTING**       | for packets arriving via any network interface               |
| **OUTPUT**           | for packets  generated by local processes                    |

**äº”ä¸ªé“¾**

| **è¡¨ï¼ˆtables****ï¼‰**       | **é“¾ï¼ˆchains****ï¼‰** |        |            |             |      |
| -------------------------- | -------------------- | ------ | ---------- | ----------- | ---- |
| INPUT                      | FORWARD              | OUTPUT | PREROUTING | POSTROUTING |      |
| **Filter**                 | âˆš                    | âˆš      | âˆš          | Ã—           | Ã—    |
| **NAT**                    | **Ã—**                | Ã—      | âˆš          | âˆš           | âˆš    |
| **Managle**                | âˆš                    | âˆš      | âˆš          | âˆš           | âˆš    |
| **raw**                    | Ã—                    | Ã—      | âˆš          | âˆš           | Ã—    |
| è¯´æ˜ï¼šâˆš è¡¨ç¤ºæœ‰ï¼ŒÃ— è¡¨ç¤ºæ— ã€‚ |                      |        |            |             |      |

![img](assets/1190037-20180118095127803-1524170528.png)

å›¾ - iptablesä¸­çš„è¡¨ä¸é“¾çš„ç»“æ„å…³ç³»

### 1.3.1 filterè¡¨çš„è¯¦ç»†ä»‹ç»

| **filterè¡¨** | ä¸»è¦å’Œä¸»æœºè‡ªèº«ç›¸å…³ï¼ŒçœŸæ­£è´Ÿè´£ä¸»æœºé˜²ç«å¢™åŠŸèƒ½çš„ï¼ˆè¿‡æ»¤æµå…¥æµå‡ºä¸»æœºçš„æ•°æ®åŒ…ï¼‰filterè¡¨æ˜¯iptablesé»˜è®¤ä½¿ç”¨çš„è¡¨ï¼Œè¿™ä¸ªè¡¨å®šä¹‰äº†ä¸‰ä¸ªé“¾ï¼ˆchainsï¼‰**ä¼ä¸šå·¥ä½œåœºæ™¯:****ä¸»æœºé˜²ç«å¢™** |
| ------------ | ------------------------------------------------------------ |
| **INPUT**    | è´Ÿè´£è¿‡æ»¤æ‰€æœ‰ç›®æ ‡æ˜¯æœ¬æœºåœ°å€çš„æ•°æ®åŒ…é€šä¿—æ¥è¯´ï¼šå°±æ˜¯è¿‡æ»¤è¿›å…¥ä¸»æœºçš„æ•°æ®åŒ… |
| **FORWARD**  | è´Ÿè´£è½¬å‘æµç»ä¸»æœºçš„æ•°æ®åŒ…ã€‚èµ·åˆ°è½¬å‘çš„ä½œç”¨ï¼Œå’ŒNATå…³ç³»å¾ˆå¤§ã€‚LVS NAT æ¨¡å¼ï¼Œnet.ipv4.ip_forward=0 |
| **OUTPUT**   | å¤„ç†æ‰€æœ‰æºåœ°å€æ˜¯æœ¬æœºåœ°å€çš„æ•°æ®åŒ…é€šä¿—çš„è®²ï¼šå°±æ˜¯å¤„ç†ä»ä¸»æœºå‘å‡ºçš„æ•°æ®åŒ… |

   å¯¹äºfilterè¡¨çš„æ§åˆ¶æ˜¯æˆ‘ä»¬å®ç°æœ¬æœºé˜²ç«å¢™åŠŸèƒ½çš„é‡è¦æ‰‹æ®µï¼Œç‰¹åˆ«æ˜¯INPUTé“¾çš„æ§åˆ¶ã€‚

### 1.3.2 NATè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»

| NATè¡¨           | è´Ÿè´£ç½‘ç»œåœ°å€è½¬æ¢çš„ï¼Œå³æ¥æºä¸ç›®çš„çš„IPåœ°å€å’Œportçš„è½¬æ¢ã€‚åº”ç”¨ï¼šå’Œä¸»æœºæœ¬èº«æ— å…³ï¼Œä¸€èˆ¬ç”¨äºå±€åŸŸç½‘å…±äº«ä¸Šç½‘æˆ–è€…ç‰¹æ®Šçš„ç«¯å£è½¬æ¢ç›¸å…³.**å·¥ä½œåœºæ™¯ï¼š**1ã€ç”¨äºä¼ä¸šè·¯ç”±(zebra)æˆ–ç½‘å…³(iptables),å…±äº«ä¸Šç½‘(POSTROUTING)2ã€åšå†…éƒ¨å¤–éƒ¨IPåœ°å€ä¸€å¯¹ä¸€æ˜ å°„(dmz),ç¡¬ä»¶é˜²ç«å¢™æ˜ å°„IPåˆ°å†…éƒ¨æœåŠ¡å™¨ï¼ŒFTPæœåŠ¡(PREROUTING)3ã€WEB,å•ä¸ªç«¯å£çš„æ˜ å°„ï¼Œç›´æ¥æ˜ å°„80ç«¯å£(PREROUTING)è¿™ä¸ªè¡¨å®šä¹‰äº†3ä¸ªé“¾ï¼ŒnatåŠŸèƒ½ç›¸å½“äºç½‘ç»œçš„aclæ§åˆ¶ã€‚å’Œç½‘ç»œäº¤æ¢æœºaclç±»ä¼¼ã€‚ |
| --------------- | ------------------------------------------------------------ |
| **OUTPUT**      | å’Œä¸»æœºæ”¾å‡ºå»çš„æ•°æ®åŒ…æœ‰å…³ï¼Œæ”¹å˜ä¸»æœºå‘å‡ºæ•°æ®åŒ…çš„ç›®çš„åœ°å€ã€‚     |
| **PREROUTING**  | åœ¨æ•°æ®åŒ…åˆ°è¾¾é˜²ç«å¢™æ—¶ï¼Œè¿›è¡Œè·¯ç”±åˆ¤æ–­ä¹‹å‰æ‰§è¡Œçš„è§„åˆ™ï¼Œä½œç”¨æ˜¯æ”¹å˜æ•°æ®åŒ…çš„ç›®çš„åœ°å€ã€ç›®çš„ç«¯å£ç­‰å°±æ˜¯æ”¶ä¿¡æ—¶ï¼Œæ ¹æ®è§„åˆ™é‡å†™æ”¶ä»¶äººçš„åœ°å€ä¾‹å¦‚ï¼šæŠŠå…¬ç½‘IPï¼š xxx.xxx.xxx.xxx æ˜ å°„åˆ°å±€åŸŸç½‘çš„ x.x.x.x æœåŠ¡å™¨å¦‚æœæ˜¯webæœåŠ¡ï¼Œå¯ä»¥æŠŠ80è½¬æ¢ä¸ºå±€åŸŸç½‘çš„æœåŠ¡å™¨9000ç«¯å£ä¸Šã€‚ |
| **POSTROUTING** | åœ¨æ•°æ®åŒ…ç¦»å¼€é˜²ç«å¢™æ—¶è¿›è¡Œè·¯ç”±åˆ¤æ–­ä¹‹åæ‰§è¡Œçš„è§„åˆ™ï¼Œä½œç”¨æ”¹å˜æ•°æ®åŒ…çš„æºåœ°å€ï¼Œæºç«¯å£ç­‰ã€‚å†™å¥½æ”¶ä»¶äººçš„åœ°å€ï¼Œè¦è®©å®¶äººå›ä¿¡æ—¶èƒ½å¤Ÿæœ‰åœ°å€å¯å›ã€‚ä¾‹å¦‚ã€‚é»˜è®¤ç¬”è®°æœ¬å’Œè™šæ‹Ÿæœºéƒ½æ˜¯å±€åŸŸç½‘åœ°å€ï¼Œåœ¨å‡ºç½‘çš„æ—¶å€™è¢«è·¯ç”±å™¨å°†æºåœ°å€æ”¹ä¸ºå…¬ç½‘åœ°å€ã€‚**ç”Ÿäº§åº”ç”¨ï¼š**å±€åŸŸç½‘å…±äº«ä¸Šç½‘ã€‚ |

### 1.3.3 Mangleè¡¨ä¿¡æ¯è¯¦ç»†ä»‹ç»

| Mangleè¡¨ | ä¸»è¦è´Ÿè´£ä¿®æ”¹æ•°æ®åŒ…ä¸­ç‰¹æ®Šçš„è·¯ç”±æ ‡è®°ï¼Œå¦‚TTL,TOS,MARKç­‰ï¼Œè¿™ä¸ªè¡¨å®šä¹‰äº†5ä¸ªé“¾(chains). |
| -------- | ------------------------------------------------------------ |
|          |                                                              |

ç”±äºè¿™ä¸ªè¡¨ä¸ç‰¹æ®Šæ ‡è®°ç›¸å…³ï¼Œä¸€èˆ¬å€©å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ä¸åˆ°è¿™ä¸ªmangleè¡¨ã€‚

è¿™é‡Œå°±ä¸åšè¯¦ç»†ä»‹ç»äº†ã€‚

## 1.4 iptableså·¥ä½œæµç¨‹

### 1.4.1 å·¥ä½œæµç¨‹è¯´æ˜

å‰é¢ä»‹ç»å·²ç»æåˆ°ï¼Œiptablesæ˜¯é‡‡ç”¨æ•°æ®åŒ…è¿‡æ»¤æœºåˆ¶å·¥ä½œçš„ï¼Œæ‰€ä»¥å®ƒä¼šå¯¹è¯·æ±‚çš„æ•°æ®åŒ…çš„åŒ…å¤´æ•°æ®è¿›è¡Œåˆ†æï¼Œå¹¶æ ¹æ®æˆ‘ä»¬é¢„å…ˆè®¾å®šçš„è§„åˆ™è¿›è¡ŒåŒ¹é…æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›å…¥ä¸»æœºã€‚

iptablesæ˜¯é‡‡ç”¨æ•°æ®åŒ…è¿‡æ»¤æœºåˆ¶å·¥ä½œçš„ï¼Œæ‰€ä»¥å®ƒä¼šå¯¹è¯·æ±‚çš„æ•°æ®åŒ…çš„åŒ…å¤´æ•°æ®è¿›è¡Œåˆ†æï¼Œå¹¶æ ¹æ®æˆ‘ä»¬é¢„å…ˆè®¾å®šçš„è§„åˆ™è¿›è¡ŒåŒ¹é…æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›å…¥ä¸»æœºã€‚

æ•°æ®åŒ…çš„æµå‘æ˜¯ä»å·¦å‘å³çš„ã€‚

 ![img](assets/1190037-20180118095142834-207194553.png)

å›¾ - iptablesåŒ…å¤„ç†æµç¨‹å›¾

 ![img](assets/1190037-20180118095149740-1977616339.png)

å›¾ - iptablesåŒ…å¤„ç†æµç¨‹å›¾(ç®€åŒ–)

**æŠ½è±¡è¯´æ˜ï¼š**ä¸Šå›¾å¯ä»¥ç”¨åŒ—äº¬åœ°é“1,2å·çº¿æ¥æè¿°ï¼š

1å·çº¿ï¼šä¸»è¦æ˜¯NATåŠŸèƒ½

>  ä¼ä¸šæ¡ˆä¾‹ï¼š
>
>  ã€€ã€€1)å±€åŸŸç½‘ä¸Šç½‘å…±äº«ï¼ˆè·¯ç”±å’Œç½‘å…³ï¼‰ï¼Œä½¿ç”¨NATçš„POSTROUTINGé“¾ã€‚
>
>  ã€€ã€€2)å¤–éƒ¨IPå’Œç«¯å£æ˜ å°„ä¸ºå†…éƒ¨IPå’Œç«¯å£ï¼ˆDMZåŠŸèƒ½ï¼‰ï¼Œä½¿ç”¨NATçš„PREROUTINGé“¾

2å·çº¿ï¼šä¸»è¦æ˜¯FILTERåŠŸèƒ½ï¼Œå³é˜²ç«å¢™åŠŸèƒ½FILTER INPUT FORWARD

> ä¼ä¸šæ¡ˆä¾‹ï¼š
>
> ã€€ã€€ä¸»è¦åº”ç”¨å°±æ˜¯ä¸»æœºæœåŠ¡å™¨é˜²ç«å¢™ï¼Œä½¿ç”¨FILTERçš„INPUTé“¾

 ![img](assets/1190037-20180118095207678-1251478781.png)

å›¾ - iptablesæ•°æ®åŒ…è½¬å‘æµç¨‹å›¾

### 1.4.2 iptableså·¥ä½œæµç¨‹å°ç»“

> 1ã€é˜²ç«å¢™æ˜¯ä¸€å±‚å±‚è¿‡æ»¤çš„ã€‚å®é™…æ˜¯æŒ‰ç…§é…ç½®è§„åˆ™çš„é¡ºåºä»ä¸Šåˆ°ä¸‹ï¼Œä»å‰åˆ°åè¿›è¡Œè¿‡æ»¤çš„ã€‚
>
> 2ã€å¦‚æœåŒ¹é…ä¸Šäº†è§„åˆ™ï¼Œå³æ˜ç¡®è¡¨æ˜æ˜¯é˜»æ­¢è¿˜æ˜¯é€šè¿‡ï¼Œæ­¤æ—¶æ•°æ®åŒ…å°±ä¸åœ¨å‘ä¸‹åŒ¹é…æ–°è§„åˆ™äº†ã€‚
>
> 3ã€å¦‚æœæ‰€æœ‰è§„åˆ™ä¸­æ²¡æœ‰æ˜ç¡®è¡¨æ˜æ˜¯é˜»æ­¢è¿˜æ˜¯é€šè¿‡è¿™ä¸ªæ•°æ®åŒ…ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åŒ¹é…ä¸Šè§„åˆ™ï¼Œå‘ä¸‹è¿›è¡ŒåŒ¹é…ï¼Œç›´åˆ°åŒ¹é…é»˜è®¤è§„åˆ™å¾—åˆ°æ˜ç¡®çš„é˜»æ­¢è¿˜æ˜¯é€šè¿‡ã€‚
>
> 4ã€é˜²ç«å¢™çš„é»˜è®¤è§„åˆ™æ˜¯å¯¹åº”é“¾çš„æ‰€æœ‰çš„è§„åˆ™æ‰§è¡Œå®Œä»¥åæ‰ä¼šæ‰§è¡Œçš„ï¼ˆæœ€åæ‰§è¡Œçš„è§„åˆ™ï¼‰ã€‚

## 1.5 iptablesæ“ä½œ

ç³»ç»Ÿç¯å¢ƒè¯´æ˜

```
[root@clsn ~]# cat /etc/redhat-release 
CentOS release 6.9 (Final)
[root@clsn ~]# hostname -I
10.0.0.188 172.16.1.188
```

è½¯ä»¶ç‰ˆæœ¬

```
[root@clsn ~]# iptables -V
iptables v1.4.7
```

### 1.5.1 iptableså‚æ•°è¯´æ˜

| **å‚æ•°**                           | **å‚æ•°è¯´æ˜**                                                 |      |      |
| ---------------------------------- | ------------------------------------------------------------ | ---- | ---- |
| **æ˜¾ç¤ºç›¸å…³å‚æ•°**                   |                                                              |      |      |
| **-n/--numeric**                   | ä»¥æ•°å­—çš„æ–¹å¼æ˜¾ç¤ºåœ°å€æˆ–ç«¯å£ä¿¡æ¯                               |      |      |
| **-L/ --list**                     | åˆ—å‡ºä¸€ä¸ªé“¾æˆ–æ‰€æœ‰é“¾ä¸­çš„è§„åˆ™ä¿¡æ¯                               |      |      |
| **--list-rules/-S**                | Print the rules in a chain or all chains                     |      |      |
| **--line-number**                  | å½“åˆ—å‡ºè§„åˆ™ä¿¡æ¯æ—¶ï¼Œæ‰“å°è§„åˆ™è¡Œå·                               |      |      |
| **-v**                             | æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥å åŠ                                        |      |      |
| **-h**                             | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯                                                 |      |      |
| **åˆå§‹åŒ–ç›¸å…³å‚æ•°**                 |                                                              |      |      |
| **iptables -F**                    | æ¸…é™¤æ‰€æœ‰è§„åˆ™ï¼Œä¸ä¼šå¤„ç†é»˜è®¤çš„è§„åˆ™                             |      |      |
| **iptables -X**                    | åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰çš„é“¾                                           |      |      |
| **iptables -Z**                    | é“¾çš„è®¡æ•°å™¨æ¸…é›¶ï¼ˆæ•°æ®åŒ…è®¡æ•°å™¨ä¸æ•°æ®åŒ…å­—èŠ‚è®¡æ•°å™¨ï¼‰             |      |      |
| **é…ç½®å¸¸ç”¨å‚æ•°**                   |                                                              |      |      |
| **-t** **è¡¨åç§°**                  | æŒ‡å®šé…ç½®å“ªä¸ªè¡¨ï¼ŒæŒ‡å®šé…ç½®è¡¨åç§°ã€‚                             |      |      |
| **--append/-A** **é“¾åç§°**         | é™„åŠ æˆ–è¿½åŠ ä¸Šç›¸åº”è§„åˆ™ç­–ç•¥ï¼Œåˆ°æŒ‡å®šé“¾(é“¾åç§°å¿…é¡»å¤§å†™)ï¼Œé»˜è®¤å°†é…ç½®çš„è§„åˆ™æ’å…¥åˆ°æœ€åä¸€æ¡ã€‚ |      |      |
| **--check/-C**                     | Check for the existence of a rule                            |      |      |
| **--insert/-I** **é“¾åç§°**         | æ’å…¥ç›¸åº”è§„åˆ™ç­–ç•¥ï¼Œåˆ°æŒ‡å®šé“¾ä¸Šï¼Œé»˜è®¤å°†é…ç½®çš„è§„åˆ™æ’å…¥åˆ°ç¬¬ä¸€æ¡ï¼ˆå¯ä»¥æ ¹æ®è§„åˆ™åºå·æ’å…¥åˆ°æŒ‡å®šä½ç½®ï¼‰--å°IPåœ°å€ä½¿ç”¨ã€‚ |      |      |
| **--delete/-D** **é“¾åç§°**         | åˆ é™¤æŒ‡å®šçš„è§„åˆ™(å¯ä»¥æ ¹æ®è§„åˆ™åºå·è¿›è¡Œåˆ é™¤)                     |      |      |
| **--replace/-R**                   | Replace rule rulenum (1 = first) in chain                    |      |      |
| **-P(****å¤§å†™)****é“¾åç§°**         | æ”¹å˜é“¾ä¸Šçš„æœ€ç»ˆé»˜è®¤è§„åˆ™ç­–ç•¥                                   |      |      |
| **--new/-N**                       | åˆ›å»ºæ–°çš„ç”¨æˆ·å®šä¹‰é“¾                                           |      |      |
| **-p** **åè®®åç§°****[!] --proto** | æŒ‡å®šè§„åˆ™çš„åè®®åç§° all tcp udp icmp                          |      |      |
| **--dport**                        | æŒ‡å®šåŒ¹é…çš„ç›®æ ‡ç«¯å£ä¿¡æ¯                                       |      |      |
| **--sport**                        | æŒ‡å®šåŒ¹é…çš„æºç«¯å£ä¿¡æ¯                                         |      |      |
| **-j** **åŠ¨ä½œ**                    | åŒ¹é…æ•°æ®åŒ…åçš„åŠ¨ä½œ                                           |      |      |
| **ACCEPT**                         | å…è®¸                                                         |      |      |
| **DROP**                           | ä¸¢å¼ƒ(æ²¡æœ‰å“åº”)                                               |      |      |
| **REJECT**                         | æ‹’ç»(å›åº”è¯·æ±‚è€…æ˜ç¡®çš„æ‹’ç»)                                   |      |      |
| **MASQUERADE**                     | ä¼ªè£…ä¸Šç½‘æ—¶ä½¿ç”¨                                               |      |      |
| **SNAT**                           | å…±äº«åœ°å€ä¸Šç½‘                                                 |      |      |
| **DNAT**                           | ç›®çš„åœ°å€æ”¹å†™                                                 |      |      |
| **-i****[!] --in-interface**       | åœ¨INPUTé“¾é…ç½®è§„åˆ™ä¸­ï¼ŒæŒ‡å®šä»å“ªä¸€ä¸ªç½‘å¡æ¥å£è¿›å…¥çš„æµé‡ï¼ˆåªèƒ½é…ç½®åœ¨INPUTé“¾ä¸Šï¼‰ |      |      |
| **-o****[!] --out-interface**      | åœ¨OUTPUTé“¾é…ç½®è§„åˆ™ä¸­ï¼ŒæŒ‡å®šä»å“ªä¸€ä¸ªç½‘æ¥å£å‡ºå»çš„æµé‡ï¼ˆåªèƒ½é…ç½®åœ¨OUTPUTé“¾ä¸Šï¼‰ |      |      |
| **-s** **[!] --source**            | æŒ‡å®šæºIPåœ°å€æˆ–æºç½‘æ®µä¿¡æ¯                                     |      |      |
| **-d****[!] --destination**        | æŒ‡å®šç›®æ ‡IPåœ°å€æˆ–ç›®æ ‡ç½‘æ®µä¿¡æ¯                                 |      |      |
| **æ‰©å±•å‚æ•°**                       |                                                              |      |      |
| **-m** **æ¨¡å—**                    | è¡¨ç¤ºå¢åŠ æ‰©å±•ï¼ŒåŒ¹é…åŠŸèƒ½æ‰©å±•åŒ¹é…ï¼ˆå¯ä»¥åŠ è½½æ‰©å±•å‚æ•°ï¼‰           |      |      |
| **multiport**                      | å®ç°ä¸è¿ç»­å¤šç«¯å£æ‰©å±•åŒ¹é…                                     |      |      |
| **icmp**                           | ä½¿ç”¨icmpçš„æ‰©å±•                                               |      |      |
| **state**                          | çŠ¶æ€æ¨¡å—æ‰©å±•                                                 |      |      |
| **--icmp-type**                    | åªæœ‰ç±»å‹8æ˜¯çœŸæ­£ä¼šå½±å“pingï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é‡‡ç”¨anyï¼›äº†è§£å¾ˆå¤šicmpç±»å‹*iptables -p icmp -h* |      |      |
| **--limit n/{second/minute/hour}** | æŒ‡å®šæ—¶é—´å†…çš„è¯·æ±‚é€Ÿç‡â€nâ€ä¸ºé€Ÿç‡ï¼Œåé¢ä¸ºæ—¶é—´åˆ†åˆ«ä¸ºï¼šç§’åˆ† æ—¶     |      |      |
| **--limit-burst [n]**              | åœ¨åŒä¸€æ—¶é—´å†…å…è®¸é€šè¿‡çš„è¯·æ±‚â€nâ€ä¸ºæ•°å­—ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸º5           |      |      |
| **--exact/-x**                     | æ‰©å±•æ•°å­—ï¼ˆæ˜¾ç¤ºç²¾ç¡®æ•°å€¼ï¼‰                                     |      |      |
|                                    |                                                              |      |      |

!çš„ä½¿ç”¨å®ä¾‹

```
[root@clsn ~]# iptables ! -V
Not 1.4.7 ;-)
[root@clsn ~]# iptables  -V
iptables v1.4.7
```

æ³¨æ„ï¼šåœ¨iptablesä¸­æ‰€æœ‰é“¾åå¿…é¡»å¤§å†™ï¼Œè¡¨æ˜å¿…é¡»å°å†™ï¼ŒåŠ¨ä½œå¿…é¡»å¤§å†™ï¼ŒåŒ¹é…å¿…é¡»å°å†™ã€‚

### 1.5.2 é…ç½®å‰å‡†å¤‡

åœ¨é…ç½®é˜²ç«å¢™é¦–å…ˆè¦å…¶ä¸­é˜²ç«å¢™

```
[root@clsn ~]# /etc/init.d/iptables start 
iptables: Applying firewall rules:                         [  OK  ]
```

æ¸…é™¤iptablesæ‰€æœ‰è§„åˆ™

```
[root@clsn ~]# iptables -Z
[root@clsn ~]# iptables -X
[root@clsn ~]# iptables -F
```

æŸ¥çœ‹iptablesçš„è§„åˆ™

```
[root@clsn ~]# iptables -nvL
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
```

æŸ¥çœ‹å…¶ä»–çš„è¡¨é…ç½®ï¼ˆ-t å‚æ•°ï¼‰

```
[root@clsn ~]# iptables -nL -t raw
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
```

æŸ¥çœ‹é…ç½®è§„åˆ™çš„é¡ºåºå·

```
[root@clsn ~]# iptables -nvL --number-list
--line-number #  æ˜¾ç¤ºè§„åˆ™çš„åºå·
```

## 1.6 iptables filterè¡¨é…ç½®å®ä¾‹

### 1.6.1 åŸºç¡€é…ç½®

**é…ç½®å®ä¾‹ä¸€ï¼š**é…ç½®22/sshç«¯å£è®¿é—®æ§åˆ¶è§„åˆ™

```
iptables -A INPUT -p tcp --dprot 22 -j DROP     # ç¦æ­¢æ‰€æœ‰äººè®¿é—®22ç«¯å£
iptables -I INPUT -p tcp --dprot 22 -j ACCEPT   # æ¢å¤è¿æ¥æ–¹æ³•
iptables -I INPUT 2 -p tcp --dprot 22 -j ACCEPT # é€šè¿‡æ’å…¥æŒ‡å®šè¡Œå·ä¿¡æ¯ï¼ŒæŒ‡å®šå°†è§„åˆ™æ’å…¥åˆ°ç¬¬å‡ è¡Œ
iptables -D INPUT -p tcp --dport 22 -j ACCEPT   # åˆ é™¤æŒ‡å®šè§„åˆ™
iptables -D INPUT 2                             # æ ¹æ®è§„åˆ™è¡Œå·ï¼Œåˆ é™¤ç›¸åº”çš„è§„åˆ™
```

åªå…è®¸10.0.0.1çš„ipé€šè¿‡sshè¿æ¥è¿™å°æœåŠ¡å™¨

```
iptables -I INPUT -s 10.0.0.1 -p tcp --dport 22 -j ACCEPT 
```

é…ç½®å®ä¾‹äºŒï¼šç¦æ­¢ç½‘æ®µè¿å…¥ï¼ˆç¦æ­¢172.16.1.0ç½‘æ®µè®¿é—®172.16.1.188ï¼‰

```
iptables -A INPUT  -s 172.16.1.0/24 -d 172.16.1.188  -j DROP
```

é…ç½®å®ä¾‹ä¸‰ï¼šç¦æ­¢æŸä¸ª172.16.1.0ç½‘æ®µè®¿é—®æœåŠ¡å™¨ä¸»æœºçš„22ç«¯å£

```
iptables -A INPUT -s 172.16.1.0/24 -d 172.16.1.188  -p tcp --dport 22 -j DROP
```

æ–¹å‘è¯´æ˜ï¼š

```
# åœ¨å…¥æ–¹å‘æ§åˆ¶
iptables -I INPUT -i eth0  -p tcp --dport 22 -j ACCEPT
# åœ¨å‡ºæ–¹å‘æ§åˆ¶
iptables -I OUTPUT -o eth0  -p tcp --sport 22 -j DROP
```

### 1.6.2 é…ç½®å®ä¾‹å››ï¼šé™¤10.0.0.0ç½‘æ®µå¯ä»¥è¿›è¡Œè¿æ¥æœåŠ¡å™¨ä¸»æœºæ„å¤–ï¼Œå…¶ä½™ç½‘æ®µéƒ½ç¦æ­¢

  ç¬¬ä¸€ç§æ–¹å¼ï¼š

```
iptables -A INPUT -s 10.0.0.0/24 -d 172.16.1.8  -j ACCEPT
```

   ä¿®æ”¹é»˜è®¤è§„åˆ™ï¼Œå°†é»˜è®¤è§„åˆ™æ”¹ä¸ºæ‹’ç»

ç¬¬äºŒç§æ–¹å¼ï¼š

   ï¼  --- è¡¨ç¤ºå¯¹è§„åˆ™ä¿¡æ¯è¿›è¡Œå–å

```
iptables -A INPUT ! -s 10.0.0.0/24 -d 172.16.1.8  -j DROP   --- centos6ç”¨æ³•
iptables -A INPUT -s ! 10.0.0.0/24 -d 172.16.1.8  -j DROP   --- centos5ç”¨æ³•
```

è¯´æ˜ï¼šåªæœ‰iptableså¸®åŠ©æ‰‹å†Œä¸­æŒ‡å®šçš„å‚æ•°å¯ä»¥ç”¨å–åç¬¦å·ï¼ˆiptables --helpï¼‰

### 1.6.3 é…ç½®å®ä¾‹äº”ï¼šæµ‹è¯•åŒ¹é…åˆ—ä¸¾ç«¯å£èŒƒå›´ã€‚

```
iptables -A INPUT -p tcp --dport 22:80 -j DROP                 # è®¾ç½®è¿ç»­å¤šç«¯å£æ§åˆ¶ç­–ç•¥
iptables -A INPUT -p tcp -m multiport  --dport 22,80 -j DROP   # è®¾ç½®ä¸è¿ç»­å¤šç«¯å£æ§åˆ¶ç­–ç•¥
```

   -m å‚æ•°è¡¨ç¤ºå¢åŠ æ‰©å±•åŒ¹é…åŠŸèƒ½ï¼Œmultiport å®ç°ä¸è¿ç»­å¤šç«¯å£æ‰©å±•åŒ¹é…

### 1.6.4 é…ç½®å®ä¾‹å…­ï¼šåŒ¹é…ICMPç±»å‹

   ç¦æ­¢pingç­–ç•¥åŸåˆ™

   iptablesæœåŠ¡å™¨æ˜¯pingå‘½ä»¤å‘èµ·è€…æˆ–æ˜¯æ¥å—è€…

**å‘èµ·è€…ï¼š**

inputé“¾ï¼š ç¦æ­¢icmp-type 0 

```
iptables -A INPUT -i eth0 -p icmp --icmp-type 0 -j DROP
```

outputé“¾ï¼š ç¦æ­¢icmp-type 8 

```
iptables -A OUTPUT -o eth0 -p icmp --icmp-type 8 -j DROP
```

   **æ¥å—è€…ï¼š**

inputé“¾ï¼š ç¦æ­¢icmp-type 8 

```
iptables -A INPUT -i eth0 -p icmp --icmp-type 8 -j DROP
```

outputé“¾ï¼š ç¦æ­¢icmp-type 0 

```
iptables -A OUTPUT -o eth0 -p icmp --icmp-type 0 -j DROP
```

ç®€åŒ–é…ç½®ï¼š

```
iptables -A INPUT -i eth0 -p icmp -m icmp --icmp-type any -j DROP  #ç¦æ­¢æ‰€æœ‰ç±»å‹çš„icmp
```

   æŒ‡å®šç±»å‹ç¦æ­¢icmp

```
iptables -A INPUT -p icmp --icmp-type 8
iptables -A INPUT -p icmp --icmp-type 8 -j DROP
iptables -A INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
iptables -A FORWARD -s 192.168.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT
```

   è¯´æ˜ï¼šåªæœ‰ç±»å‹8æ˜¯çœŸæ­£ä¼šå½±å“pingï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é‡‡ç”¨anyï¼›äº†è§£å¾ˆå¤šicmpç±»å‹iptables -p icmp -h

**ICMPç±»å‹çš„è¯´æ˜**

| TYPE   | CODE | Description                                                  | Query | Error |
| ------ | ---- | ------------------------------------------------------------ | ----- | ----- |
| **0**  | 0    | Echo Replyâ€”â€”å›æ˜¾åº”ç­”ï¼ˆPingåº”ç­”ï¼‰                             | x     |       |
| **3**  | 0    | Network Unreachableâ€”â€”ç½‘ç»œä¸å¯è¾¾                              |       | x     |
| **3**  | 1    | Host Unreachableâ€”â€”ä¸»æœºä¸å¯è¾¾                                 |       | x     |
| **3**  | 2    | Protocol Unreachableâ€”â€”åè®®ä¸å¯è¾¾                             |       | x     |
| **3**  | 3    | Port Unreachableâ€”â€”ç«¯å£ä¸å¯è¾¾                                 |       | x     |
| **3**  | 4    | Fragmentation needed but no frag. bit setâ€”â€”éœ€è¦è¿›è¡Œåˆ†ç‰‡ä½†è®¾ç½®ä¸åˆ†ç‰‡æ¯”ç‰¹ |       | x     |
| **3**  | 5    | Source routing failedâ€”â€”æºç«™é€‰è·¯å¤±è´¥                          |       | x     |
| **3**  | 6    | Destination network unknownâ€”â€”ç›®çš„ç½‘ç»œæœªçŸ¥                    |       | x     |
| **3**  | 7    | Destination host unknownâ€”â€”ç›®çš„ä¸»æœºæœªçŸ¥                       |       | x     |
| **3**  | 8    | Source host isolated (obsolete)â€”â€”æºä¸»æœºè¢«éš”ç¦»ï¼ˆä½œåºŸä¸ç”¨ï¼‰    |       | x     |
| **3**  | 9    | Destination network administratively prohibitedâ€”â€”ç›®çš„ç½‘ç»œè¢«å¼ºåˆ¶ç¦æ­¢ |       | x     |
| **3**  | 10   | Destination host administratively prohibitedâ€”â€”ç›®çš„ä¸»æœºè¢«å¼ºåˆ¶ç¦æ­¢ |       | x     |
| **3**  | 11   | Network unreachable for TOSâ€”â€”ç”±äºæœåŠ¡ç±»å‹TOSï¼Œç½‘ç»œä¸å¯è¾¾     |       | x     |
| **3**  | 12   | Host unreachable for TOSâ€”â€”ç”±äºæœåŠ¡ç±»å‹TOSï¼Œä¸»æœºä¸å¯è¾¾        |       | x     |
| **3**  | 13   | Communication administratively prohibited by filteringâ€”â€”ç”±äºè¿‡æ»¤ï¼Œé€šä¿¡è¢«å¼ºåˆ¶ç¦æ­¢ |       | x     |
| **3**  | 14   | Host precedence violationâ€”â€”ä¸»æœºè¶Šæƒ                          |       | x     |
| **3**  | 15   | Precedence cutoff in effectâ€”â€”ä¼˜å…ˆä¸­æ­¢ç”Ÿæ•ˆ                    |       | x     |
| **4**  | 0    | Source quenchâ€”â€”æºç«¯è¢«å…³é—­ï¼ˆåŸºæœ¬æµæ§åˆ¶ï¼‰                      |       |       |
| **5**  | 0    | Redirect for networkâ€”â€”å¯¹ç½‘ç»œé‡å®šå‘                           |       |       |
| **5**  | 1    | Redirect for hostâ€”â€”å¯¹ä¸»æœºé‡å®šå‘                              |       |       |
| **5**  | 2    | Redirect for TOS and networkâ€”â€”å¯¹æœåŠ¡ç±»å‹å’Œç½‘ç»œé‡å®šå‘         |       |       |
| **5**  | 3    | Redirect for TOS and hostâ€”â€”å¯¹æœåŠ¡ç±»å‹å’Œä¸»æœºé‡å®šå‘            |       |       |
| **8**  | 0    | Echo requestâ€”â€”å›æ˜¾è¯·æ±‚ï¼ˆPingè¯·æ±‚ï¼‰                           | x     |       |
| **9**  | 0    | Router advertisementâ€”â€”è·¯ç”±å™¨é€šå‘Š                             |       |       |
| **10** | 0    | Route solicitationâ€”â€”è·¯ç”±å™¨è¯·æ±‚                               |       |       |
| **11** | 0    | TTL equals 0 during transitâ€”â€”ä¼ è¾“æœŸé—´ç”Ÿå­˜æ—¶é—´ä¸º0             |       | x     |
| **11** | 1    | TTL equals 0 during reassemblyâ€”â€”åœ¨æ•°æ®æŠ¥ç»„è£…æœŸé—´ç”Ÿå­˜æ—¶é—´ä¸º0  |       | x     |
| **12** | 0    | IP header bad (catchall error)â€”â€”åçš„IPé¦–éƒ¨ï¼ˆåŒ…æ‹¬å„ç§å·®é”™ï¼‰   |       | x     |
| **12** | 1    | Required options missingâ€”â€”ç¼ºå°‘å¿…éœ€çš„é€‰é¡¹                     |       | x     |
| **13** | 0    | Timestamp request (obsolete)â€”â€”æ—¶é—´æˆ³è¯·æ±‚ï¼ˆä½œåºŸä¸ç”¨ï¼‰         | x     |       |
| **14** |      | Timestamp reply (obsolete)â€”â€”æ—¶é—´æˆ³åº”ç­”ï¼ˆä½œåºŸä¸ç”¨ï¼‰           | x     |       |
| **15** | 0    | Information request (obsolete)â€”â€”ä¿¡æ¯è¯·æ±‚ï¼ˆä½œåºŸä¸ç”¨ï¼‰         | x     |       |
| **16** | 0    | Information reply (obsolete)â€”â€”ä¿¡æ¯åº”ç­”ï¼ˆä½œåºŸä¸ç”¨ï¼‰           | x     |       |
| **17** | 0    | Address mask requestâ€”â€”åœ°å€æ©ç è¯·æ±‚                           | x     |       |
| **18** | 0    | Address mask replyâ€”â€”åœ°å€æ©ç åº”ç­”                             |       |       |

æ•°æ®æ¥æºï¼šhttp://www.cnitblog.com/yang55xiaoguang/articles/59581.html

### 1.6.5 é˜²ç«å¢™çŠ¶æ€æœºåˆ¶é…ç½®

çŠ¶æ€é›†ç®€å•è¯´æ˜:

| **çŠ¶æ€é›†**      | **è¯´æ˜**                                           |
| --------------- | -------------------------------------------------- |
| **NEW**         | è¡¨ç¤ºæ–°å»ºç«‹è¿æ¥çš„æ•°æ®åŒ…çŠ¶æ€                         |
| **ESTABLISHED** | è¡¨ç¤ºæ–°å»ºç«‹è¿æ¥æ•°æ®åŒ…å‘é€ä¹‹åï¼Œå›å¤å“åº”çš„æ•°æ®åŒ…çŠ¶æ€ |
| **RELATED**     | è¡¨ç¤ºå€ŸåŠ©å·²ç»å»ºç«‹çš„é“¾è·¯ï¼Œå‘é€æ–°çš„è¿æ¥æ•°æ®åŒ…         |
| **INVALID**     | æ— æ•ˆæ— æ³•è¯†åˆ«çš„æ•°æ®åŒ…                               |

æ³¨æ„ï¼šå…è®¸å…³è”çš„çŠ¶æ€åŒ…é€šè¿‡ï¼ˆwebæœåŠ¡ä¸è¦ä½¿ç”¨FTPæœåŠ¡ï¼‰

é˜²ç«å¢™æœåŠ¡é…ç½®åœ¨FTPæœåŠ¡å™¨ä¸Šæ—¶ï¼Œéœ€è¦é…ç½®ä»¥ä¸‹ç­–ç•¥

 

```
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

å®ç°å‘ç°sent_synçŠ¶æ€

```
iptables -A INPUT -m state --state NEW -j DROP    # é˜²ç«å¢™æ‰€è¿æ¥å®¢æˆ·ç«¯ä¸Šé…ç½®
```

å®ç°å‘ç°sent_rcvdçŠ¶æ€

```
iptables -I INPUT -i eth0 -s 10.0.0.201 -m state --state ESTABLISHED -j DROP  # é˜²æŠ¤å¢™ä¸Šé…ç½®çš„
```

### 1.6.6 ä½¿ç”¨iptableså®ç°é™é€ŸåŠŸèƒ½

limitæ˜¯iptablesçš„ä¸€ä¸ªåŒ¹é…æ¨¡å—ï¼Œç”¨å®ƒç»“åˆiptablesçš„å…¶å®ƒå‘½ä»¤å¯ä»¥å®ç°é™é€Ÿçš„åŠŸèƒ½ã€‚

ä¸è¿‡é¦–å…ˆå¿…é¡»æ˜ç¡®ï¼Œlimitæœ¬èº«åªæ˜¯ä¸€ä¸ªâ€œåŒ¹é…â€æ¨¡å—ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œiptablesçš„åŸºæœ¬åŸç†æ˜¯â€œåŒ¹é…--å¤„ç†â€ï¼Œlimitåœ¨è¿™ä¸ªå·¥ä½œè¿‡ç¨‹ä¸­åªèƒ½èµ·åˆ°åŒ¹é…çš„ä½œç”¨ï¼Œå®ƒæœ¬èº«æ˜¯æ— æ³•å¯¹ç½‘ç»œæ•°æ®åŒ…è¿›è¡Œä»»ä½•å¤„ç†çš„ã€‚æˆ‘çœ‹åˆ°ç½‘ä¸Šæœ‰äº›limitçš„ä¾‹å­é‡Œé¢è¯´åª ç”¨ä¸€æ¡åŒ…å«limitåŒ¹é…è§„åˆ™çš„iptablesè¯­å¥å°±å¯ä»¥å®ç°é™é€Ÿï¼Œé‚£æ˜¯é”™è¯¯çš„ã€‚

å®é™…ä¸Šï¼Œåˆ©ç”¨imitæ¥é™é€Ÿéœ€è¦åŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤:

1.å¯¹ç¬¦åˆlimitåŒ¹é…è§„åˆ™åŒ…æ”¾è¡Œ

2.ä¸¢å¼ƒ/æ‹’ç»æœªæ”¾è¡Œçš„åŒ…

ç¤ºä¾‹ï¼š

```
iptables -I INPUT -s 10.0.0.7 -p icmp --icmp-type 8 -m limit --limit 6/min --limit-burst 5 -j ACCEPT 
iptables -I INPUT -s 10.0.0.7 -p icmp --icmp-type 8 -j DROP
```

   è¯­å¥å«ä¹‰ï¼šå½“æ¥è‡ª10.0.0.7 çš„pingåŒ…è¶…è¿‡5ä¸ªæ—¶è¿›è¡Œé™é€Ÿï¼Œé™åˆ¶ä¸ºæ¯10sä¸€ä¸ªã€‚

å‚æ•°è¯´æ˜ï¼š

| **å‚æ•°**                           | **å‚æ•°å«ä¹‰**                                              |
| ---------------------------------- | --------------------------------------------------------- |
| **--limit n/{second/minute/hour}** | æŒ‡å®šæ—¶é—´å†…çš„è¯·æ±‚é€Ÿç‡â€nâ€ä¸ºé€Ÿç‡ï¼Œåé¢ä¸ºæ—¶é—´åˆ†åˆ«ä¸ºï¼šç§’ åˆ† æ—¶ |
| **--limit-burst [n]**              | åœ¨åŒä¸€æ—¶é—´å†…å…è®¸é€šè¿‡çš„è¯·æ±‚â€nâ€ä¸ºæ•°å­—ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸º5        |

**limit****æ¨¡å—å…·ä½“æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ï¼Ÿ**

limitçš„åŒ¹é…æ˜¯åŸºäºä»¤ç‰Œæ¡¶ (Token bucketï¼‰æ¨¡å‹çš„ã€‚

ä»¤ç‰Œæ¡¶æ˜¯ä¸€ç§ç½‘ç»œé€šè®¯ä¸­å¸¸è§çš„ç¼“å†²åŒºå·¥ä½œåŸç†ï¼Œå®ƒæœ‰ä¸¤ä¸ªé‡è¦çš„å‚æ•°ï¼Œä»¤ç‰Œæ¡¶å®¹é‡nå’Œä»¤ç‰Œäº§ç”Ÿé€Ÿç‡sã€‚

> æˆ‘ä»¬å¯ä»¥æŠŠä»¤ç‰Œå½“æˆæ˜¯é—¨ç¥¨ï¼Œè€Œä»¤ç‰Œæ¡¶åˆ™æ˜¯è´Ÿè´£åˆ¶ä½œå’Œå‘æ”¾é—¨ç¥¨çš„ç®¡ç†å‘˜ï¼Œå®ƒæ‰‹é‡Œæœ€å¤šæœ‰nå¼ ä»¤ç‰Œã€‚ä¸€å¼€å§‹ï¼Œç®¡ç†å‘˜å¼€å§‹æ‰‹é‡Œæœ‰nå¼ ä»¤ç‰Œã€‚æ¯å½“ä¸€ä¸ªæ•°æ®åŒ…åˆ°è¾¾åï¼Œç®¡ç†å‘˜å°±çœ‹çœ‹æ‰‹é‡Œæ˜¯å¦è¿˜æœ‰å¯ç”¨çš„ä»¤ç‰Œã€‚å¦‚æœæœ‰ï¼Œå°±æŠŠä»¤ç‰Œå‘ç»™è¿™ä¸ªæ•°æ®åŒ…ï¼Œlimitå°±å‘Šè¯‰iptablesï¼Œè¿™ä¸ªæ•°æ®åŒ…è¢«åŒ¹é…äº†ã€‚è€Œå½“ç®¡ç†å‘˜æŠŠæ‰‹ä¸Šæ‰€æœ‰çš„ä»¤ç‰Œéƒ½å‘å®Œäº†ï¼Œå†æ¥çš„æ•°æ®åŒ…å°±æ‹¿ä¸åˆ°ä»¤ç‰Œäº†ã€‚è¿™æ—¶ï¼Œlimitæ¨¡å—å°±å‘Šè¯‰iptablesï¼Œè¿™ä¸ªæ•°æ®åŒ…ä¸èƒ½è¢«åŒ¹é…ã€‚é™¤äº†å‘æ”¾ä»¤ç‰Œä¹‹å¤–ï¼Œåªè¦ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œæ•°é‡å°‘äºnï¼Œå®ƒå°±ä¼šä»¥é€Ÿç‡sæ¥äº§ç”Ÿæ–°çš„ä»¤ç‰Œï¼Œç›´åˆ°ä»¤ç‰Œæ•°é‡åˆ°è¾¾nä¸ºæ­¢ã€‚

é€šè¿‡ä»¤ç‰Œæ¡¶æœºåˆ¶ï¼Œå³å¯ä»¥æœ‰æ•ˆçš„æ§åˆ¶å•ä½æ—¶é—´å†…é€šè¿‡ï¼ˆåŒ¹é…ï¼‰çš„æ•°æ®åŒ…æ•°é‡ï¼Œåˆå¯ä»¥å®¹è®¸çŸ­æ—¶é—´å†…çªå‘çš„å¤§é‡æ•°æ®åŒ…çš„é€šè¿‡ï¼ˆåªè¦æ•°æ®åŒ…æ•°é‡ä¸è¶…è¿‡ä»¤ç‰Œæ¡¶nï¼‰ã€‚

limitæ¨¡å—æä¾›äº†ä¸¤ä¸ªå‚æ•°--limitå’Œ--limit-burstï¼Œåˆ†åˆ«å¯¹åº”äºä»¤ç‰Œäº§ç”Ÿé€Ÿç‡å’Œä»¤ç‰Œæ¡¶å®¹é‡ã€‚é™¤äº†ä»¤ç‰Œæ¡¶æ¨¡å‹å¤–ï¼ŒlimitåŒ¹é…çš„å¦å¤–ä¸€ä¸ªé‡è¦æ¦‚å¿µæ˜¯åŒ¹é…é¡¹ã€‚åœ¨limitä¸­ï¼Œæ¯ä¸ªåŒ¹é…é¡¹æ‹¥æœ‰ä¸€ä¸ªå•ç‹¬çš„ä»¤ç‰Œæ¡¶ï¼Œæ‰§è¡Œç‹¬ç«‹çš„åŒ¹é…è®¡ç®—ã€‚

### 1.6.7 ä¼ä¸šçº§é˜²ç«å¢™é…ç½®

æ¸…é™¤é˜²ç«å¢™è§„åˆ™

```
[root@clsn ~]# iptables -F
[root@clsn ~]# iptables -X
[root@clsn ~]# iptables -Z
```

ä¿®æ”¹é»˜è®¤è§„åˆ™ä¸ºæ‹’ç»ï¼ˆä¿®æ”¹å‰å…ˆæ”¾è¡Œ22ç«¯å£ï¼Œä¿è¯è‡ªå·±èƒ½å¤Ÿè¿ä¸Šä¸»æœºï¼‰

```
[root@clsn ~]# iptables -A INPUT -p tcp --dport  22 -j ACCEPT
[root@clsn ~]# iptables -P INPUT DROP 
[root@clsn ~]# iptables -P FORWARD DROP
```

æ”¾è¡ŒæŒ‡å®šçš„ç«¯å£

```
[root@clsn ~]# iptables -A INPUT -i lo -j ACCEPT
[root@clsn ~]# iptables -A INPUT  -p tcp  -m multiport --dport  80,443 -j ACCEPT
[root@clsn ~]# iptables -A INPUT -s 172.16.1.0/24 -j ACCEPT
[root@clsn ~]# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

**ä¿å­˜iptables****é…ç½®**

\01. ç¬¬ä¸€ç§æ–¹å¼

```
[root@clsn ~]# /etc/init.d/iptables save
iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]
[root@clsn ~]# cat /etc/sysconfig/iptables
# Generated by iptables-save v1.4.7 on Tue Apr  4 12:24:43 2017
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [159:10664]
-A INPUT -s 10.0.0.0/24 -j ACCEPT 
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT 
-A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT 
-A INPUT -s 172.16.1.0/24 -j ACCEPT 
-A INPUT -i lo -j ACCEPT 
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
COMMIT
# Completed on Tue Apr  4 12:24:43 2017
```

\02. ç¬¬äºŒç§æ–¹å¼

```
iptables-save >/etc/sysconfig/iptables
```

## 1.7 iptables natè¡¨é…ç½®å®ä¾‹

### 1.7.1 iptableså®ç°å…±äº«ä¸Šç½‘

 ![img](assets/1190037-20180118095907193-681615791.png)

å›¾ - SNAT é…ç½®åŸç†å›¾

ç¬¬ä¸€ä¸ªé‡Œç¨‹ç¢‘ï¼šé…ç½®å†…ç½‘æœåŠ¡å™¨ï¼Œè®¾ç½®ç½‘å…³åœ°å€

```
/etc/init.d/iptables stop      # å†…ç½‘æœåŠ¡å™¨åœæ­¢é˜²ç«å¢™æœåŠ¡
ifdown eth0                    # æ¨¡æ‹Ÿå…³é—­å†…ç½‘æœåŠ¡å™¨å¤–ç½‘ç½‘å¡
setup                          # ä¿®æ”¹å†…ç½‘ç½‘å¡ç½‘å…³å’ŒDNSåœ°å€ä¿¡æ¯
```

ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤æ·»åŠ é»˜è®¤ç½‘å…³

```
route add default gw 172.16.1.188
```

æŸ¥çœ‹é»˜è®¤çš„è·¯ç”±ä¿¡æ¯

```
[root@test ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
172.16.1.0      0.0.0.0         255.255.255.0   U     0      0        0 eth1
169.254.0.0     0.0.0.0         255.255.0.0     U     1003   0        0 eth1
0.0.0.0         172.16.1.188    0.0.0.0         UG    0      0        0 eth1
```

è¯´æ˜ï¼šå†…ç½‘æœåŠ¡å™¨ç½‘å…³åœ°å€æŒ‡å®šä¸ºå…±äº«ä¸Šç½‘æœåŠ¡å™¨å†…ç½‘ç½‘å¡åœ°å€

ç¬¬äºŒä¸ªé‡Œç¨‹ç¢‘ï¼šé…ç½®å…±äº«ä¸Šç½‘æœåŠ¡å™¨ï¼Œå¼€å¯å…±äº«ä¸Šç½‘æœåŠ¡å™¨è·¯ç”±è½¬å‘åŠŸèƒ½

```
[root@clsn ~]# vim /etc/sysctl.conf 
[root@clsn ~]# sysctl -p
~~~
net.ipv4.ip_forward = 1
~~~
```

ç¬¬ä¸‰ä¸ªé‡Œç¨‹ç¢‘ï¼šé…ç½®å…±äº«ä¸Šç½‘æœåŠ¡å™¨ï¼Œå®ç°å†…ç½‘è®¿é—®å¤–ç½‘çš„NATæ˜ å°„

```
iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -o eth0 -j SNAT --to-source 10.0.0.188
```

å‚æ•°è¯¦è§£ï¼š

| **å‚æ•°**                        | **å‚æ•°è¯´æ˜**                              |
| ------------------------------- | ----------------------------------------- |
| **-s 172.16.1.0/24**            | æŒ‡å®šå°†å“ªäº›å†…ç½‘ç½‘æ®µè¿›è¡Œæ˜ å°„è½¬æ¢            |
| **-o eth0**                     | æŒ‡å®šåœ¨å…±äº«ä¸Šç½‘å“ªä¸ªç½‘å¡æ¥å£ä¸ŠåšNATåœ°å€è½¬æ¢ |
| **-j SNAT**                     | å°†æºåœ°å€è¿›è¡Œè½¬æ¢å˜æ›´                      |
| **-j DNAT**                     | å°†ç›®æ ‡åœ°å€è¿›è¡Œè½¬æ¢å˜æ›´                    |
| **--to-source ip****åœ°å€**      | å°†æºåœ°å€æ˜ å°„ä¸ºä»€ä¹ˆIPåœ°å€                  |
| **--to-destination ip****åœ°å€** | å°†ç›®æ ‡åœ°å€æ˜ å°„ä¸ºä»€ä¹ˆIPåœ°å€                |

å½“filterè¡¨ä¸­çš„forwardé»˜è®¤ä¸ºdropç­–ç•¥æ—¶ï¼Œå¦‚ä½•é…ç½®forwardé“¾ï¼Ÿ

 ![img](assets/1190037-20180118100154553-999721017.png)

å›¾ - forwardå·¥ä½œåŸç†

   **é…ç½®ç¤ºä¾‹**

```
iptables -A FORWARD -i eth1 -s 172.16.1.0/24 -j ACCEPT
# iptables -A FORWARD -o eth0 -s 172.16.1.0/24 -j ACCEPT  # å¯ä»¥ä¸è¿›è¡Œé…ç½®
iptables -A FORWARD -i eth0 -d 172.16.1.0/24 -j ACCEPT
# iptables -A FORWARD -o eth1 -d 172.16.1.0/24 -j ACCEPT   # å¯ä»¥ä¸è¿›è¡Œé…ç½®
```

å½“å¤–ç½‘ipä¸å›ºå®šæ—¶å¦‚ä½•é…ç½®ï¼Ÿ

```
iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -o eth0 -j MASQUERADE   # ä¼ªè£…å…±äº«ä¸Šç½‘
```

è¯´æ˜ï¼šåœ¨ä¼ä¸šä¸­å¦‚ä½•æ²¡æœ‰å›ºå®šå¤–ç½‘IPåœ°å€ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸Šä¼ªè£…æ˜ å°„çš„æ–¹å¼è¿›è¡Œå…±äº«ä¸Šç½‘

**é…ç½®æ˜ å°„æ–¹æ³•å°ç»“**

>  \01. æŒ‡å®šå“ªäº›ç½‘æ®µéœ€è¦è¿›è¡Œæ˜ å°„     -s 172.16.1.0/24
>
> \02. æŒ‡å®šåœ¨å“ªåšæ˜ å°„               -o eth0
>
> \03. ç”¨ä»€ä¹ˆæ–¹æ³•åšæ˜ å°„             -j SNAT/DNAT MASQUERADE
>
> \04. æ˜ å°„æˆä»€ä¹ˆåœ°å€               --to-source  ipåœ°å€/--to-destination ipåœ°å€

### 1.7.2 iptableså®ç°å¤–ç½‘IPçš„ç«¯å£æ˜ å°„åˆ°å†…ç½‘IPçš„ç«¯å£

å®é™…éœ€æ±‚ï¼šå°†ç½‘å…³çš„IPå’Œ9000ç«¯å£æ˜ å°„åˆ°å†…ç½‘æœåŠ¡å™¨çš„22ç«¯å£

ç«¯å£æ˜ å°„ 10.0.0.188:9000 -->172.16.1.180:22

é…ç½®å®ä¾‹ï¼š

```
iptables -t nat -A PREROUTING -d 10.0.0.188 -p tcp --dport 9000 -i eth0 -j DNAT --to-destination 172.16.1.7:22
```

å‚æ•°è¯´æ˜:

| **å‚æ•°**          | **å‚æ•°è¯´æ˜**   |
| ----------------- | -------------- |
| **-d 10.0.0.188** | ç›®æ ‡åœ°å€ã€‚     |
| **-j DNAT**       | ç›®çš„åœ°å€æ”¹å†™ã€‚ |

### 1.7.3 IPä¸€å¯¹ä¸€æ˜ å°„

![img](assets/1190037-20180118100320756-725387577.png)

å›¾ - DNAT æ˜ å°„åŸç†

   å®é™…éœ€æ±‚ï¼šå°†ip åœ°å€172.16.1.180 æ˜ å°„åˆ°10.0.0.188

é€šè¿‡è¾…åŠ©IPé…ç½®ï¼š

```
ip addr add 10.0.0.81/24 dev eth0 label eth0:0   # æ·»åŠ è¾…åŠ©IP
iptables  -t nat -I PREROUTING -d 10.0.0.81 -j DNAT --to-destination 172.16.1.51
iptables  -t nat -I POSTROUTING -s 172.16.1.51 -o eth0 -j SNAT --to-source 10.0.0.81
```

é€‚åˆå†…ç½‘çš„æœºå™¨è®¿é—®NATå¤–ç½‘çš„IP

```
iptables  -t nat -I POSTROUTING -s 172.16.1.0/255.255.240.0 -d 10.0.0.81 -j SNAT --to-source 172.16.1.8
```

æ£€æŸ¥é…ç½®ï¼š

```
ping 10.0.0.81 -t
tcpdump|grep -i icmpï¼ˆä¸¤å°æœºå™¨ä¸Šåˆ†åˆ«ç›‘æµ‹ï¼‰
telnet 10.0.0.81 22
```

### 1.7.4 æ˜ å°„å¤šä¸ªå¤–ç½‘IPä¸Šç½‘

   æ–¹æ³•1ï¼š

```
iptables -t nat -A POSTROUTING -s 10.0.1.0/255.255.240.0 -o eth0 -j SNAT --to-source 124.42.60.11-124.42.60.16
```

â€‹      åœ¨ä¸‰å±‚äº¤æ¢æœºæˆ–è·¯ç”±å™¨ï¼Œåˆ’åˆ†VLANã€‚

   æ–¹æ³•2ï¼š

```
iptables -t nat -A POSTROUTING -s 10.0.1.0/22 -o eth0 -j SNAT --to-source 124.42.60.11
iptables -t nat -A POSTROUTING -s 10.0.2.0/22 -o eth0 -j SNAT --to-source 124.42.60.12
```

â€‹      æ‰©å¤§å­ç½‘ï¼Œä¼šå¢åŠ å¹¿æ’­é£æš´ã€‚

### 1.7.5 ç³»ç»Ÿé˜²ç«å¢™ä¸ç½‘ç»œå†…æ ¸ä¼˜åŒ–æ ‡å‡†å‚æ•°

æœ‰å…³iptablesçš„å†…æ ¸ä¼˜åŒ–

è°ƒæ•´å†…æ ¸å‚æ•°æ–‡ä»¶/etc/sysctl.conf

ä»¥ä¸‹æ˜¯æˆ‘çš„ç”Ÿäº§ç¯å¢ƒçš„æŸä¸ªæœåŠ¡å™¨çš„é…ç½®ï¼š

**è§£å†³time-wait****è¿‡å¤š**çš„è§£å†³åŠæ³•ï¼š

```
net.ipv4.tcp_fin_timeout = 2
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.ip_local_port_range = 4000  65000
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.route.gc_timeout = 100
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_synack_retries = 1
```

åœ¨dmesgä¸­æ˜¾ç¤º  ip_conntrack: table full, dropping packet. çš„é”™è¯¯æç¤ºï¼Œä»€ä¹ˆåŸå› ï¼Ÿ

å¦‚ä½•è§£å†³ï¼Ÿ

   \#iptablesä¼˜åŒ–

```
net.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_tcp_timeout_established = 180
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
```

## 1.8 è‡ªå®šä¹‰é“¾çš„é…ç½®

 ![img](assets/1190037-20180118100524162-470889662.png)

å›¾ - è‡ªå®šä¹‰é“¾åŸç†

åˆ›å»ºè‡ªå®šä¹‰é“¾

```
#ç¤ºä¾‹ï¼šåœ¨filterè¡¨ä¸­åˆ›å»ºNOICMPè‡ªå®šä¹‰é“¾
iptables -t filter -N NOICMP
```

å¼•ç”¨è‡ªå®šä¹‰é“¾

```
#ç¤ºä¾‹ï¼šåœ¨INPUTé“¾ä¸­å¼•ç”¨åˆšæ‰åˆ›å»ºçš„è‡ªå®šä¹‰é“¾
iptables -t filter -I INPUT -p icmp  -j NOICMP
```

é‡å‘½åè‡ªå®šä¹‰é“¾

```
#ç¤ºä¾‹ï¼šå°†IN_WEBè‡ªå®šä¹‰é“¾é‡å‘½åä¸ºWEB
iptables -E NOICMP ACCEPTICMP
```

åˆ é™¤è‡ªå®šä¹‰é“¾

>  åˆ é™¤è‡ªå®šä¹‰é“¾éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶
>
> ã€€ã€€1ã€è‡ªå®šä¹‰é“¾æ²¡æœ‰è¢«å¼•ç”¨
>
> ã€€ã€€2ã€è‡ªå®šä¹‰é“¾ä¸­æ²¡æœ‰ä»»ä½•è§„åˆ™

```
# ç¤ºä¾‹ï¼š åˆ é™¤å¼•ç”¨æ•°ä¸º0ä¸”ä¸åŒ…å«ä»»ä½•è§„åˆ™çš„ACCEPTICMPé“¾
iptables -X ACCEPTICMP
```

## 1.9 é™„å½•-é˜²ç«å¢™çŠ¶æ€æœºåˆ¶

çŠ¶æ€æœºåˆ¶æ˜¯iptablesä¸­è¾ƒä¸ºç‰¹æ®Šçš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä¹Ÿæ˜¯iptableså’Œæ¯”è¾ƒè€çš„ipchainsçš„ä¸€ä¸ªæ¯”è¾ƒå¤§çš„åŒºåˆ¥ä¹‹ä¸€ï¼Œè¿è¡ŒçŠ¶æ€æœºåˆ¶ï¼ˆè¿æ¥è·Ÿè¸ªï¼‰çš„é˜²ç«å¢™ç§°ä½œå¸¦æœ‰çŠ¶æ€æœºåˆ¶çš„é˜²ç«å¢™ï¼Œä»¥ä¸‹ç®€ç§°ä¸ºçŠ¶æ€é˜²ç«å¢™.çŠ¶æ€é˜²ç«å¢™æ¯”éçŠ¶æ€é˜²ç«å¢™è¦å®‰å…¨ï¼Œå› ä¸ºå®ƒå…è®¸æˆ‘ä»¬ç¼–å†™æ›´ä¸¥å¯†çš„è§„åˆ™ã€‚

åœ¨iptablesä¸Šä¸€å…±æœ‰å››ç§çŠ¶æ€ï¼Œåˆ†åˆ«è¢«ç§°ä¸ºNEWã€ESTABLISHEDã€INVALIDã€RELATED,è¿™å››ç§çŠ¶æ€å¯¹äºTCPã€UDPã€ICMPä¸‰ç§åè®®å‡æœ‰æ•ˆã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ†åˆ«é˜è¿°å››ç§çŠ¶æ€çš„ç‰¹æ€§.

**ğŸ”” NEW**

meaning that the packet has started a new connection, or otherwise associated with a connection which has not seen packets in both directions

NEWè¯´æ˜è¿™ä¸ªåŒ…æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ç¬›ä¸€ä¸ªåŒ…ã€‚æ„æ€å°±æ˜¯ï¼Œè¿™æ˜¯conntrackæ¨ªå—çœ‹åˆ°çš„æŸä¸ªè¿æ¥çš„ç¬¬ä¸€ä¸ªåŒ…ï¼Œå®ƒå³æ ¼è¢«åŒ¹é…äº†ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªSYNåŒ…ï¼Œæ˜¯æˆ‘ä»¬æ‰€ç•™æ„çš„è¿æ¥çš„ç¬¬ä¸€ä¸ªåŒ…ï¼Œå°±è¦åŒ¹é…å®ƒã€‚

![img](assets/1190037-20180118100700365-1333317962.png) 

**ğŸ”” ESTABLISHED**

meaning that the packet is associated with a connection which has seen packets in both directions

ESTABLISHEDå·²ç»æ³¨æ„åˆ°ä¸¤ä¸ªæ–¹å‘ä¸Šçš„æ•°æ®ä¼ è¾“ï¼Œè€Œä¸”ä¼šç»§ç»­åŒ¹é…è¿™ä¸ªè¿æ¥çš„åŒ….å¤„äºESTABLISHEDçŠ¶æ€çš„è¿æ¥æ˜¯éå¸¸å®¹æ˜“ç†è§£çš„.åªè¦å‘é€å¹¶æ¥åˆ°åº”ç­”ï¼Œè¿æ¥å°±æ˜¯ESTABLISHEDçš„äº†ã€‚ä¸€ä¸ªè¿æ¥è¦ä»NEWå˜ä¸ºESTABLISHED,åªéœ€è¦æ¥åˆ°åº”ç­”åŒ…å³å¯ï¼Œä¸ç®¡è¿™ä¸ªåŒ…æ˜¯å‘å¾€é˜²ç«å¢™çš„ï¼Œè¿˜æ˜¯è¦ç”±é˜²ç«å¢™è½¬å‘çš„.ICMPçš„é”™è¯¯å’Œé‡å®šå‘ç­‰ä¿¡æ¯åŒ…ä¹Ÿè¢«çœ‹ä½œæ˜¯ESTABLISHED,åªè¦å®ƒä»¬æ˜¯æˆ‘ä»¬æ‰€å‘å‡ºçš„ä¿¡æ¯çš„åº”ç­”ã€‚

 ![img](assets/1190037-20180118100709240-1842733823.png)

**ğŸ””** RELATED

meaning that the packet is starting a new connection, but is associated with an existing connection, such as an FTP data transfer, or an ICMP error.

RELATEDæ˜¯ä¸ªæ¯”è¾ƒéº»çƒ¦çš„çŠ¶æ€.å½“ä¸€ä¸ªè¿æ¥å’ŒæŸä¸ªå·²å¤„äºESTABLISHEDçŠ¶æ€çš„è¿æ¥æœ‰å…³ç³»æ—¶ï¼Œå°±è¢«è®¤ä¸ºæ˜¯RELATEDçš„äº†ï¼Œæ¢å¥è¯è¯´ï¼Œä¸€ä¸ªè¿æ¥è¦æƒ³æ˜¯RELATEDçš„ï¼Œé¦–å…ˆè¦æœ‰ä¸€ä¸ªESTABLISHEDçš„è¿æ¥ã€‚è¿™ä¸ªESTABLISHEDè¿æ¥å†äº§ç”Ÿä¸€ä¸ªä¸»è¿æ¥ä¹‹å¤–çš„è¿æ¥ï¼Œè¿™ä¸ªæ–°çš„è¿æ¥å°±æ˜¯RELATEDçš„äº†ï¼Œå½“ç„¶å‰ææ˜¯conntrackæ¨¡å—è¦èƒ½ç†è§£RELATEDã€‚ftpæ˜¯ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼ŒFTP-dataè¿æ¥å°±æ˜¯å’ŒFTP-controlæœ‰å…³è”çš„ï¼Œå¦‚æœæ²¡æœ‰åœ¨iptablesçš„ç­–ç•¥ä¸­é…RELATEDçŠ¶æ€ï¼ŒFTP-dataçš„è¿æ¥æ˜¯æ— æ³•æ­£ç¡®å»ºç«‹çš„ï¼Œè¿˜æœ‰å…¶ä»–çš„ä¾‹å­ï¼Œæ¯”å¦‚ï¼Œé€šè¿‡IRCçš„DCCè¿æ¥#æœ‰äº†è¿™ä¸ªçŠ¶æ€ï¼ŒICMPåº”ç­”ã€FTPä¼ è¾“ã€DCCç­‰æ‰èƒ½ç©¿è¿‡é˜²ç«å¢™æ­£å¸¸å·¥ä½œ.æ³¨æ„ï¼Œå¤§éƒ¨åˆ†è¿˜æœ‰ä¸€äº›UDPåè®®éƒ½ä¾èµ–è¿™ä¸ªæœºåˆ¶ã€‚è¿™äº›åè®®æ˜¯å¾ˆå¤æ‚çš„ï¼Œå®ƒä»¬æŠŠè¿æ¥ä¿¡æ¯æ”¾åœ¨æ•°æ®åŒ…é‡Œï¼Œå¹¶ä¸”è¦æ±‚è¿™äº›ä¿¡æ¯èƒ½è¢«æ­£ç¡®ç†è§£ã€‚

![img](assets/1190037-20180118100716459-532997150.png) 

**ğŸ”” INVALID**

meaning that the packet is associated with no known connection

INVALIDè¯´æ˜æ•°æ®åŒ…ä¸èƒ½è¢«è¯†åˆ«å±äºå“ªä¸ªè¿æ¥æˆ–æ²¡æœ‰ä»»ä½•çŠ¶æ€.æœ‰å‡ ä¸ªåŸå› å¯ä»¥äº§ç”Ÿè¿™ç§æƒ…å†µï¼Œæ¯”å¦‚ï¼Œå†…å­˜æº¢å‡ºï¼Œæ”¶åˆ°ä¸çŸ¥å²äºå“ªä¸ªè¿æ¥çš„ICMPé”™è¯¯ä¿¡æ¯ã€‚ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬DROPè¿™ä¸ªçŠ¶æ€çš„ä»»ä½•ä¸œè¥¿ï¼Œå› ä¸ºé˜²ç«å¢™è®¤ä¸ºè¿™æ˜¯ä¸å®‰å…¨çš„ä¸œè¥¿

 ![img](assets/1190037-20180118100722240-904097578.png)

### 1.9.1 iptablesé…ç½®å“²å­¦

å¦‚ä½•é˜²æ­¢è‡ªå·±è¢«å…³åœ¨é—¨å¤–ï¼Ÿ

>  01ã€å»æœºæˆ¿é‡å¯ç³»ç»Ÿæˆ–è€…ç™»é™†æœåŠªå™¨åˆ é™¤åˆšæ‰çš„ç¦æ­¢è§„åˆ™ã€‚
>
> 02ã€è®©æœºæˆ¿äººå‘˜é‡å¯æœèŠ³å™¨æˆ–è€…è®©æœºæˆ¿äººå‘˜æ‹¿ç”¨æˆ·å¯†ç ç™»å½•è¿›å»ã€‚
>
> 03ã€é€šè¿‡æœåŠªå™¨çš„è¿œç¨‹ç®¡ç†å¡ç®¡ç†ï¼ˆæ¨èï¼‰ã€‚
>
> 04ã€å…ˆå†™ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯5åˆ†é’Ÿå°±åœæ­¢é˜²ç«å¢™ã€‚
>
> 05ã€æµ‹è¯•ç¯å¢ƒæµ‹è¯•å¥½ï¼Œå†™æˆè„šæœ¬ï¼Œæ‰¹ç½®æ‰§è¡Œ

é…ç½®ç¦ç”¨22ç«¯å£ç­–ç•¥:

```
iptables -I INPUT -p tcp - dport 22 -j DROP
# è¯´æ˜ï¼šåˆ©ç”¨-Iå‚æ•°ï¼Œå®ç°å¼ºè¡Œé˜»æ­¢è®¿é—®22ç«¯å£ï¼Œå°†Jffcè§„åˆ™æ”¾åœ¨ç¬¬ä¸€ä½
```

åˆ é™¤é…ç½®çš„ç¦æ­¢è¿æ¥22ç«¯å£çš„è§„åˆ™

```
iptables -t filter -D INPUT -p tcp â€”dport 22 -j DROP
iptables -F
/etc/init.d/iptables restart
```
